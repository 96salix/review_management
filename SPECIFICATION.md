# 仕様書

## 1. 目的

ソースコードのレビュープロセスを支援し、開発者とレビュアー間のコミュニケーションを円滑にするためのWebアプリケーション。

## 2. 利用者

*   開発者: レビューを依頼する人。
*   レビュアー: ソースコードをレビューする人。

## 3. プラットフォーム

*   Webアプリケーション

## 4. 主な機能

### 4.1. レビュー依頼機能
*   開発者は、レビュー対象のソースコード（例: GitHubのPull Request URL）を指定してレビューを依頼できる。
*   依頼時に、複数のレビュアーを指名できる。
*   レビュー依頼は、複数の「ステージ」を持つことができる。

### 4.2. レビュー機能
*   依頼されたソースコードの差分を表示する（本プロトタイプではURLへのリンクのみ）。
*   レビュアーは、コードの特定の行に対してコメントを投稿できる（本プロトタイプではステージ全体へのコメント）。
*   レビュー依頼全体に対する一般的なコメントも投稿できる。

### 4.3. 状況管理機能
*   レビュアーは、自身のレビュー状況を以下のいずれかのステータスで更新できる。
    *   未着手 (`pending`)
    *   コメントあり (`commented`)
    *   回答済み (`answered`)
    *   LGTM (`lgtm`)
*   レビュー依頼の詳細画面で、各レビュアーの状況を一覧表示する。

### 4.4. ダッシュボード機能
*   ユーザーが関わるレビュー依頼（自分が依頼したもの、自分が担当するもの）を一覧で表示する。

### 4.5. 複数段階レビュー
*   1つのレビュー依頼の中に、複数のレビュー段階（ステージ）を設定できる。
*   各ステージには、それぞれ異なるレビュアーを割り当てることができる。
*   コメントやレビュアーのステータスは、各ステージごとに管理される。
*   各ステージは独自のリポジトリURLを持つことができる。

### 4.6. アクティビティログ機能
*   レビュー依頼の作成、ステータス変更、コメント追加など、すべての主要なアクションを時系列で記録する。
*   ログは、誰が、いつ、どのようなアクションを行ったかを示す。

### 4.7. ユーザー管理機能
*   ユーザー（レビュアーや依頼者）の情報を管理する。
*   ユーザーの作成、一覧取得、更新、削除が可能。

### 4.8. ステージテンプレート管理機能
*   レビュー依頼作成時に利用できる、ステージ構成のテンプレートを管理する。
*   テンプレートには、ステージ名とデフォルトのレビュアーのリストが含まれる。
*   テンプレートの作成、一覧取得、更新、削除が可能。

## 5. 画面構成（日本語化・デザイン改善後）

### 5.1. ヘッダー
*   左側にアプリケーション名「レビュー管理」を表示。
*   右側に「レビュー一覧」「自分のレビュー」「新規作成」「ステージテンプレート管理」「ユーザー管理」ボタンを配置。

### 5.2. レビュー一覧画面 (`/`)
*   すべてのレビュー依頼をカード形式で一覧表示する。
*   各カードには、タイトル、依頼者、作成日時、レビュアーのアイコンを表示する。
*   カード全体が詳細ページへのリンクになっている。

### 5.3. 自分のレビュー画面 (`/my-reviews`)
*   自分がレビュアーとして担当しているレビュー依頼のみをカード形式で一覧表示する。
*   各カードには、レビュー依頼のタイトル、担当ステージ名、リポジトリURL、および自分のレビューステータス（横並びのボタンで編集可能）が表示される。
*   レビューは「未着手」「回答済み」「コメントあり」「LGTM」の優先順位でソートされる。
*   LGTMステータスのレビューカードは、視覚的に区別できるようグレー表示される。

### 5.4. レビュー依頼詳細画面 (`/reviews/:id`)
*   依頼のタイトル、依頼者、作成日時をカードヘッダーに表示する。
*   右上に「編集」ボタンを配置し、編集画面へ遷移できる。
*   レビューのステージをタブで切り替えられるようにする。
*   各ステージについて、以下の情報を表示する。
    *   レビュアーとそのステータスの一覧。ステータスは横並びのボタンで変更可能。
    *   コメントのスレッド（返信機能を含む）。アイコン付きで誰のコメントか分かりやすく表示。
    *   コメント投稿フォーム。
*   情報はリアルタイムで更新される。
*   **アクティビティログセクション:** レビュー依頼に関するすべてのログを時系列で表示する。

### 5.5. レビュー依頼作成画面 (`/new`)
*   レビューのタイトルを入力するフォーム。
*   レビューのステージを追加・編集・削除する機能。
    *   各ステージには、ステージ名とリポジトリURL、レビュアー（チェックボックスで複数選択）を指定する。
*   「レビュー依頼を作成」ボタンを押すと、依頼が作成され、詳細画面に遷移する。

### 5.6. レビュー依頼編集画面 (`/reviews/:id/edit`)
*   既存のレビュー依頼の情報をフォームに表示し、編集できる。
*   「更新」ボタンを押すと、変更が保存され、詳細画面に遷移する。

### 5.7. ユーザー管理画面 (`/users`)
*   登録されているユーザーを一覧表示する。
*   ユーザーの新規作成、編集、削除が行える。

### 5.8. ステージテンプレート管理画面 (`/stage-templates`)
*   登録されているステージテンプレートを一覧表示する。
*   テンプレートの新規作成、編集、削除が行える。

## 6. データ構造とAPI

*   **アーキテクチャ**: フロントエンド(React)、バックエンド(Node.js/Express)、データベース(PostgreSQL)の3層構造で、それぞれがDockerコンテナとして動作します。
*   **データモデル**: 型定義は `app/src/types.ts` と `backend/src/types.ts` に存在します。
    *   `Comment` モデルは `parentCommentId` を持ち、コメントの返信（スレッド）機能をサポートします。
    *   `ReviewRequest` は `activityLogs` フィールドを持ち、関連する操作の履歴を記録します。
    *   主要なモデルには `User`, `ReviewRequest`, `StageTemplate` などが含まれます。
*   **データベース**: PostgreSQLを使用し、テーブル定義は `init.sql` に記載されています。
*   **APIエンドポイント**: バックエンドは以下のRESTful APIを提供します。
    *   **レビュー関連**
        *   `GET /api/reviews`
        *   `GET /api/reviews/:id`
        *   `POST /api/reviews`
        *   `PUT /api/reviews/:id`
        *   `PUT /api/reviews/:reviewId/stages/:stageId/assignments/:reviewerId`
        *   `POST /api/reviews/:reviewId/stages/:stageId/comments`
    *   **ユーザー管理**
        *   `GET /api/users`
        *   `POST /api/users`
        *   `PUT /api/users/:id`
        *   `DELETE /api/users/:id`
    *   **ステージテンプレート管理**
        *   `GET /api/stage-templates`
        *   `POST /api/stage-templates`
        *   `PUT /api/stage-templates/:id`
        *   `DELETE /api/stage-templates/:id`

## 7. 認証

*   バックエンドのミドルウェアで認証を処理します。
*   フロントエンドからのリクエストに含まれる `X-User-Id` カスタムヘッダーを元に、データベースから現在のユーザー情報を取得して利用します。
